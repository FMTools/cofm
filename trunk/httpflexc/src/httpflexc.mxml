<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" minWidth="955" minHeight="600"
			   creationComplete="initView();">
	<s:layout>
		<s:VerticalLayout/>
	</s:layout>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import mx.controls.Alert;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.http.HTTPService;
			
			private var svr: HTTPService;
			private var myId: int;
			
			private function initView(): void {
				svr = new HTTPService();
				svr.method = "POST";
				svr.url="http://fms.seforge.org";
				svr.resultFormat="text";
				svr.addEventListener(FaultEvent.FAULT, onFault);
				svr.addEventListener(ResultEvent.RESULT, onResult);
				svr.send({
					mode: "handshake"
				});
			}
			
			private function onFault(evt: FaultEvent): void {
				Alert.show(evt.fault.toString(), "Error");
			}
			
			private function onResult(evt: ResultEvent): void {
				var rsp: String = String(evt.result); 
				trace (">>> '" + rsp + "', " + evt.statusCode);
				if (rsp.indexOf("_Handshake_") == 0) {
					myId = int(rsp.substr("_Handshake_".length));
				} else if (rsp.length > 0) {
					displayer.text += rsp + "\n";
				}
				// reconnect with "read" mode
				if (rsp.length > 0) {
					svr.send({
						mode: "read",
						clientId: myId
					});
				}
			}
			
			private function onSendText(): void {
				svr.disconnect();
				svr.send({
					mode: "write",
					message: inputer.text,
					clientId: myId
				});
			}
			
			private function onQuit(): void {
				svr.send({
					mode: "disconnect",
					clientId: myId
				});
			}
		]]>
	</fx:Script>
	
	<s:TextArea id="displayer" width="400" height="300" editable="false"/>
	
	<s:HGroup>
		<s:TextInput id="inputer" width="300"/>
		<s:Button label="Send" click="onSendText();"/>
		<s:Button label="Quit" click="onQuit();"/>
	</s:HGroup>
</s:Application>
